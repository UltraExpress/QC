<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Wash Quality Control Checklist</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Previous styles remain the same */
        .checklist-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease;
        }
        .checklist-item.completed {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
        }
        .checklist-item.disabled {
            opacity: 0.7;
            pointer-events: none;
        }
        .checklist-item.disabled * {
            pointer-events: none;
        }
        .validation-message {
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 10px;
            display: none;
        }
        .validation-message.visible {
            display: block;
        }
        /* Rest of previous styles remain the same */
    </style>
</head>
<body>
    <!-- Previous HTML structure remains the same -->
    <script>
        // Previous variables and constants remain the same

        // Add completion status to items
        items.forEach(item => {
            item.score = 0;
            item.notes = '';
            item.image = null;
            item.completed = false;
            item.enabled = item.id === 1; // Only first item enabled initially
        });

        function createChecklistItem(item) {
            const div = document.createElement('div');
            div.className = `checklist-item ${item.completed ? 'completed' : ''} ${!item.enabled ? 'disabled' : ''}`;
            div.id = `item-${item.id}`;
            
            const percentage = calculateItemPercentage(item);
            
            div.innerHTML = `
                <div class="item-header">
                    <h3>${item.name} (Weight: ${item.weight})</h3>
                    <div class="item-controls">
                        <select onchange="updateScore(${item.id}, this.value)" ${!item.enabled ? 'disabled' : ''}>
                            <option value="0" ${item.score === 0 ? 'selected' : ''}>Select Score</option>
                            <option value="1" ${item.score === 1 ? 'selected' : ''}>1 - Poor</option>
                            <option value="2" ${item.score === 2 ? 'selected' : ''}>2 - Fair</option>
                            <option value="3" ${item.score === 3 ? 'selected' : ''}>3 - Good</option>
                            <option value="4" ${item.score === 4 ? 'selected' : ''}>4 - Very Good</option>
                            <option value="5" ${item.score === 5 ? 'selected' : ''}>5 - Excellent</option>
                        </select>
                        <input type="file" 
                               id="image-${item.id}" 
                               accept="image/*" 
                               style="display: none"
                               onchange="handleImageUpload(${item.id}, this)"
                               ${!item.enabled ? 'disabled' : ''}>
                        <button class="button" 
                                onclick="document.getElementById('image-${item.id}').click()"
                                ${!item.enabled ? 'disabled' : ''}>
                            ðŸ“· Upload Photo
                        </button>
                    </div>
                </div>
                <div class="score-details">
                    Raw Score: ${item.score}/5 | Weight: ${item.weight} | 
                    <span class="percentage">Running at ${percentage.toFixed(1)}% of perfect</span>
                </div>
                <textarea
                    placeholder="Add notes here... (Required)"
                    onchange="updateNotes(${item.id}, this.value)"
                    ${!item.enabled ? 'disabled' : ''}
                >${item.notes}</textarea>
                <div id="preview-${item.id}">
                    ${item.image ? `<img src="${item.image}" class="photo-preview">` : ''}
                </div>
                <div class="validation-message" id="validation-${item.id}">
                    Please complete all required fields: Score, Notes, and Photo
                </div>
            `;
            return div;
        }

        function validateItem(id) {
            const item = items.find(i => i.id === id);
            if (!item) return false;

            const isValid = item.score > 0 && 
                          item.notes.trim().length > 0 && 
                          item.image !== null;

            const validationMessage = document.getElementById(`validation-${id}`);
            if (validationMessage) {
                validationMessage.classList.toggle('visible', !isValid);
            }

            return isValid;
        }

        function updateScore(id, score) {
            const item = items.find(i => i.id === id);
            if (item) {
                item.score = parseInt(score);
                checkItemCompletion(id);
                updateTotalScore();
                updateProgress();
                saveToLocalStorage();
            }
        }

        function updateNotes(id, notes) {
            const item = items.find(i => i.id === id);
            if (item) {
                item.notes = notes;
                checkItemCompletion(id);
                saveToLocalStorage();
            }
        }

        function handleImageUpload(id, input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            canvas.width = height;
                            canvas.height = width;
                        } else {
                            canvas.width = width;
                            canvas.height = height;
                        }

                        const ctx = canvas.getContext('2d');
                        ctx.translate(canvas.width/2, canvas.height/2);
                        ctx.rotate(0);
                        ctx.drawImage(img, -width/2, -height/2, width, height);

                        const correctedImage = canvas.toDataURL('image/jpeg', 0.7);
                        
                        const item = items.find(i => i.id === id);
                        if (item) {
                            item.image = correctedImage;
                            const preview = document.getElementById(`preview-${id}`);
                            preview.innerHTML = `<img src="${correctedImage}" class="photo-preview">`;
                            checkItemCompletion(id);
                            saveToLocalStorage();
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function checkItemCompletion(id) {
            const item = items.find(i => i.id === id);
            if (!item) return;

            const isValid = validateItem(id);
            if (isValid) {
                item.completed = true;
                const nextItem = items.find(i => i.id === id + 1);
                if (nextItem) {
                    nextItem.enabled = true;
                }
                renderChecklist();
            }
        }

        // Update other functions to include new properties when saving/loading
        function saveToLocalStorage() {
            localStorage.setItem('qcChecklist', JSON.stringify(items));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('qcChecklist');
            if (saved) {
                const savedItems = JSON.parse(saved);
                items.forEach((item, index) => {
                    Object.assign(item, savedItems[index]);
                });
            }
        }

        // Rest of the code remains the same
    </script>
</body>
</html>
