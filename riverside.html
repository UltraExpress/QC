<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
   

          <script src="video-handler.js"></script>
    
   <style>
body {
    font-family: Arial, sans-serif;
    max-width: 800px;
    margin: 20px auto;
    padding: 20px;
    font-size: 18px;
    background-color: #1a1a1a;
    color: white;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}
.reset-btn {
    background: #ff6b6b;
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
    font-size: 20px;
    font-weight: bold;
}
.reset-btn:hover {
    background: #ff5252;
}

.qc-item {
    background: #2a2a2a;
    color: #ffffff;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: background-color 0.3s;
}

.qc-item.complete {
    background: #90EE90;
}
.item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #ddd;
}
.item-title {
    font-size: 24px;
    font-weight: bold;
}
.item-weight {
    background: #4a4a4a;  /* Darker background */
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 18px;
    color: white;    /* White text for better contrast */
    font-weight: bold;
}
.rating-group {
    margin: 15px 0;
}
.rating-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 10px;
}
.rating-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    border: 2px solid #ddd;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.3s;
    min-height: 100px;
}
.rating-btn .number {
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 8px;
}
.rating-btn .description {
    font-size: 16px;
    text-align: center;
    line-height: 1.4;
}
.rating-btn.selected {
    background: #4CAF50;
    color: white;
    border-color: #4CAF50;
}
.notes {
    width: 100%;
    margin: 15px 0;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
    min-height: 120px;
    box-sizing: border-box;
    font-size: 18px;
}
/* Find this section in your CSS */
.image-upload {
    margin: 15px 0;
}
.image-upload input[type="file"] {
    width: 100%;
    padding: 15px 30px;
    font-size: 20px;
    background: #2196F3;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    margin: 10px 0;
    font-weight: bold;
    height: auto;
}

.image-upload input[type="file"]::file-selector-button {
    padding: 10px 20px;
    border-radius: 6px;
    border: none;
    background: white;
    color: #2196F3;
    font-weight: bold;
    margin-right: 15px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.image-upload input[type="file"]:hover {
    background: #1976D2;
}

.image-upload input[type="file"]:disabled {
    background: #6c757d;
    cursor: not-allowed;
}

.image-upload input[type="file"]:disabled::file-selector-button {
    background: #e0e0e0;
    color: #6c757d;
    cursor: not-allowed;
}

.image-preview {
    max-width: 100%;
    margin-top: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.section-label {
    font-weight: bold;
    margin-bottom: 10px;
    color: white;
    font-size: 20px;
}
h2 {
    font-size: 28px;
}
.loading {
    text-align: center;
    padding: 20px;
    font-size: 20px;
    color: #666;
}
.error {
    background: #ffebee;
    color: #c62828;
    padding: 20px;
    border-radius: 8px;
    margin: 20px 0;
}

.total-score {
    font-size: 24px;
    font-weight: bold;
    padding: 15px;
    background: #2a2a2a;
    color: white;
    border-radius: 8px;
    margin-bottom: 20px;
}

.pdf-button {
    width: 100%;
    padding: 20px;
    font-size: 24px;
    background: #ccc;
    color: #666;
    border: none;
    border-radius: 8px;
    margin-top: 30px;
    cursor: not-allowed;
    transition: all 0.3s;
}
.pdf-button.ready {
    background: #007bff;
    color: white;
    cursor: pointer;
}
.pdf-button.ready:hover {
    background: #0056b3;
}
.inspector-section {
    margin: 1rem 0;
    padding: 0 1rem;
}
.inspector-input {
    width: 100%;
    max-width: 300px;
    padding: 0.5rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 1rem;
    color: white;
    background-color: #343a40;
}
.inspector-input:focus {
    outline: none;
    border-color: #0056b3;
}

/* Video Styles */
.video-section {
    margin: 15px 0;
}

.video-preview, .video-playback {
    width: 100%;
    margin: 10px 0;
    border-radius: 4px;
    background: #000;
}

.record-btn {
    width: 100%;
    padding: 15px 30px;
    font-size: 20px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    margin: 10px 0;
    font-weight: bold;
    text-transform: uppercase;
}

.record-btn:hover {
    background: #c82333;
}

.record-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
}

.timer {
    font-family: monospace;
    font-size: 20px;
    margin: 10px 0;
    text-align: center;
    color: white;
}

.status {
    margin: 10px 0;
    padding: 10px;
    border-radius: 4px;
    word-break: break-all;
}
</style>
</head>
<body>
    <div class="header">
        <h2>Quality Control Checklist RIVERSIDE</h2>
        <button class="reset-btn" onclick="resetForm()">Reset All Items</button>
    </div>






    

 <div class="inspector-section">
        <input 
            type="text" 
            id="inspector-name" 
            placeholder="Inspector Name" 
            class="inspector-input"
        >
    </div>


    





    
    <div id="total-score" class="total-score">Total Score: 0</div>
    
    <div id="checklist-container">
        <div class="loading">Loading checklist items...</div>
    </div>

    <button id="pdfButton" class="pdf-button" onclick="generatePDF()" disabled>
        Make a PDF Report
    </button>








    

    <script>
        let checklistItems = [];

        let inspectorName = '';




// Add this new IndexedDB initialization code
const dbName = 'QCImagesDB';
const storeName = 'images';
let db;

const initDB = () => {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(dbName, 1);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            db = request.result;
            resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(storeName)) {
                db.createObjectStore(storeName, { keyPath: 'id' });
            }
        };
    });
};


        
// Add the event listener for DB initialization
document.addEventListener('DOMContentLoaded', initDB);


        async function compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // Max dimensions
                const MAX_WIDTH = 1024;
                const MAX_HEIGHT = 1024;
                
                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width *= MAX_HEIGHT / height;
                        height = MAX_HEIGHT;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // Convert to blob with compression
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/jpeg', 0.6); // 60% quality
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}






        // Save image to IndexedDB
async function saveImageToIndexedDB(index, imageData) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        
        const imageRecord = {
            id: `image_${index}`,
            data: imageData
        };
        
        const request = store.put(imageRecord);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
    });
}

// Load image from IndexedDB
async function loadImageFromIndexedDB(index) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.get(`image_${index}`);
        
        request.onsuccess = () => resolve(request?.result?.data || null);
        request.onerror = () => reject(request.error);
    });
}
        

document.getElementById('inspector-name').addEventListener('input', function(e) {
    inspectorName = e.target.value.trim();
    
    // Get all interactive elements
    const ratingButtons = document.querySelectorAll('.rating-btn');
    const noteInputs = document.querySelectorAll('.notes');
    const fileInputs = document.querySelectorAll('input[type="file"]');
    const pdfButton = document.getElementById('pdfButton');
    
    // Enable/disable based on inspector name
    if (inspectorName) {
        ratingButtons.forEach(btn => {
            btn.disabled = false;
            btn.style.cursor = 'pointer';
        });
        noteInputs.forEach(input => {
            input.disabled = false;
            input.style.cursor = 'text';
        });
        fileInputs.forEach(input => {
            input.disabled = false;
            input.style.cursor = 'pointer';
        });
        
            if (checkAllItemsComplete()) {
            pdfButton.disabled = false;
            pdfButton.classList.add('ready');
        }
    } else {
        ratingButtons.forEach(btn => {
            btn.disabled = true;
            btn.style.cursor = 'not-allowed';
        });
        noteInputs.forEach(input => {
            input.disabled = true;
            input.style.cursor = 'not-allowed';
        });
        fileInputs.forEach(input => {
            input.disabled = true;
            input.style.cursor = 'not-allowed';
        });
        pdfButton.disabled = true;
        pdfButton.classList.remove('ready');
    }

    saveToLocalStorage(); // Added this line to save when inspector name changes
    renderChecklist();
});


        function saveToLocalStorage() {
    const storageData = {
        inspectorName: inspectorName,
        checklistItems: checklistItems,
        lastUpdated: new Date().toISOString()
    };
    localStorage.setItem('qcFormData', JSON.stringify(storageData));
}

async function loadFromLocalStorage() {
    await initDB(); // Make sure DB is initialized
    
    const savedData = localStorage.getItem('qcFormData');
    if (savedData) {
        const parsedData = JSON.parse(savedData);
        
        inspectorName = parsedData.inspectorName;
        document.getElementById('inspector-name').value = inspectorName;
        
        if (parsedData.checklistItems && parsedData.checklistItems.length > 0) {
            checklistItems = parsedData.checklistItems;
            renderChecklist();
            updateTotalScore();
            
            // Load images and restore videos
            setTimeout(async () => {
                for (let i = 0; i < checklistItems.length; i++) {
                    const item = checklistItems[i];
                    
                    // Load images
                    try {
                        const imageData = await loadImageFromIndexedDB(i);
                        if (imageData) {
                            const preview = document.querySelector(`.image-preview-${i}`);
                            if (preview) {
                                const img = document.createElement('img');
                                img.src = imageData;
                                img.className = 'image-preview';
                                preview.innerHTML = '';
                                preview.appendChild(img);
                            }
                        }
                    } catch (error) {
                        console.error('Error loading image:', error);
                    }
                    
                    // Restore video playback if URL exists
                    if (item.videoUrl) {
                        const playback = document.querySelector(`#video-playback-${item.id}`);
                        if (playback) {
                            playback.src = item.videoUrl;
                            playback.style.display = 'block';
                            // Hide the preview element since we're showing the playback
                            const preview = document.querySelector(`#video-preview-${item.id}`);
                            if (preview) {
                                preview.style.display = 'none';
                            }
                        }
                    }
                }
            }, 100);
        }
    }
}

        


        

        async function loadChecklist() {
    try {
        const response = await fetch('https://ultraexpress.github.io/QC/riverside-checklist.json');
        if (!response.ok) throw new Error('Failed to load checklist data');
        
        const data = await response.json();
        const savedData = localStorage.getItem('qcFormData');
        
        // Initialize with fresh checklist
        checklistItems = data.items.map(item => ({
            ...item,
            score: 0,
            notes: "",
            image: null,
            video: undefined
        }));
        
        // If we have saved data, merge it into the fresh checklist
        if (savedData) {
            const parsed = JSON.parse(savedData);
            if (parsed.checklistItems) {
                checklistItems = checklistItems.map((freshItem, index) => {
                    const savedItem = parsed.checklistItems[index];
                    if (savedItem && savedItem.id === freshItem.id) {
                        return {
                            ...freshItem,
                            score: savedItem.score || 0,
                            notes: savedItem.notes || "",
                            image: savedItem.image || null,
                            videoUrl: savedItem.videoUrl,
                        };
                    }
                    return freshItem;
                });
            }
            // Restore inspector name
            if (parsed.inspectorName) {
                inspectorName = parsed.inspectorName;
                document.getElementById('inspector-name').value = inspectorName;
            }
        }
        
        renderChecklist();
    } catch (error) {
        document.getElementById('checklist-container').innerHTML = `
            <div class="error">
                Error loading checklist: ${error.message}
                <br>Please refresh the page to try again.
            </div>
        `;
    }
}

// Remove or comment out the loadFromLocalStorage() call in the original loadChecklist()






        


function renderChecklist() {
    const container = document.getElementById('checklist-container');
    container.innerHTML = checklistItems.map((item, index) => `
        <div class="qc-item" data-id="${item.id}">
            <div class="item-header">
                <span class="item-title">${item.name}</span>
                <span class="item-weight">Weight: ${item.weight}</span>
            </div>
            
            <div class="rating-group">
                <div class="section-label">Quality Rating:</div>
                <div class="rating-options">
                    ${[1,2,3,4,5].map(rating => `
                        <button class="rating-btn ${item.score === rating ? 'selected' : ''}" 
                            onclick="setRating(${index}, ${rating})" 
                            ${!inspectorName ? 'disabled' : ''}>
                            <span class="number">${rating}</span>
                            <span class="description">${getRatingDescription(rating)}</span>
                        </button>
                    `).join('')}
                </div>
            </div>

            <div>
                <div class="section-label">Notes:</div>
                <textarea class="notes" 
                    onchange="updateNotes(${index}, this.value)" 
                    placeholder="Enter detailed observations here..."
                    ${!inspectorName ? 'disabled' : ''}>${item.notes}</textarea>
            </div>

            <div class="image-upload">
                <div class="section-label">Upload Images:</div>
                <input type="file" 
                    accept="image/*" 
                    multiple 
                    onchange="handleImageUpload(${index}, event)"
                    ${!inspectorName ? 'disabled' : ''}>
                <div class="image-preview-${index}"></div>
            </div>
             <div class="video-section">
                <div class="section-label">Record Video:</div>
                <button id="record-btn-${item.id}" 
                    class="record-btn" 
                    onclick="videoHandlers['${item.id}'].toggleRecording()"
                    ${!inspectorName ? 'disabled' : ''}>
                    Start Recording
                </button>
                <div id="timer-${item.id}" class="timer" style="display: none;">00:00</div>
                <video id="video-preview-${item.id}" 
                    class="video-preview" 
                    style="display: none;" 
                    autoplay 
                    playsinline 
                    webkit-playsinline 
                    muted>
                </video>
                <video id="video-playback-${item.id}" 
                    class="video-playback" 
                    style="display: none;" 
                    playsinline
                    webkit-playsinline
                    controls>
                </video>
                <div id="video-status-${item.id}" class="status"></div>
            </div>
        </div>
    `).join('');

    // Initialize video handlers for each item
    checklistItems.forEach(item => {
        if (!window.videoHandlers) window.videoHandlers = {};
        window.videoHandlers[item.id] = new VideoHandler(item.id);
    });
    
    // Check completion status and update total score
    checklistItems.forEach((item, index) => {
        checkComplete(index);
    });
    updateTotalScore();
    checkAllItemsComplete();

    // Restore video playback if URLs exist
    checklistItems.forEach(item => {
        if (item.videoUrl) {
            const playback = document.querySelector(`#video-playback-${item.id}`);
            if (playback) {
                playback.src = item.videoUrl;
                playback.style.display = 'block';
                const preview = document.querySelector(`#video-preview-${item.id}`);
                if (preview) {
                    preview.style.display = 'none';
                }
            }
        }
    });
}








        

        function getRatingDescription(rating) {
            const descriptions = {
                1: "Critical Issues<br>Immediate Action Required",
                2: "Major Issues<br>Needs Significant Work",
                3: "Minor Issues<br>Acceptable with Fixes",
                4: "Good Quality<br>Minor Improvements",
                5: "Perfect Quality<br>Meets All Standards"
            };
            return descriptions[rating];
        }

    function checkComplete(index) {
    const item = checklistItems[index];
    const hasScore = item.score > 0;
    const hasNotes = item.notes.trim() !== '';
    const hasImage = item.image !== null;
   
 
    const hasVideo = item.videoUrl !== undefined;
    
    const itemElement = document.querySelector(`.qc-item[data-id="${item.id}"]`);
    if (hasScore && hasNotes && hasImage && hasVideo) {
        itemElement.classList.add('complete');
    } else {
        itemElement.classList.remove('complete');
    }
}

     function checkAllItemsComplete() {
            const allComplete = checklistItems.every(item => 
                item.score > 0 && 
                item.notes.trim() !== '' && 
                item.image !== null
                 && item.videoUrl !== undefined
            );
            
            const pdfButton = document.getElementById('pdfButton');
            if (allComplete) {
                pdfButton.classList.add('ready');
                pdfButton.disabled = false;
            } else {
                pdfButton.classList.remove('ready');
                pdfButton.disabled = true;
            }
        }

        function setRating(index, rating) {
    const itemElement = document.querySelector(`.qc-item[data-id="${checklistItems[index].id}"]`);
    const buttons = itemElement.querySelectorAll('.rating-btn');
    
    buttons.forEach(btn => {
        btn.classList.remove('selected');
        if (parseInt(btn.querySelector('.number').textContent) === rating) {
            btn.classList.add('selected');
        }
    });
    
    checklistItems[index].score = rating;
    checkComplete(index);
    updateTotalScore();
    checkAllItemsComplete();
    saveToLocalStorage(); // Added this line to save after setting rating
}

     function updateNotes(index, notes) {
    checklistItems[index].notes = notes;
    checkComplete(index);
    checkAllItemsComplete();
    saveToLocalStorage(); // Added this line to save after updating notes
}

async function handleImageUpload(index, event) {
    const preview = document.querySelector(`.image-preview-${index}`);
    preview.innerHTML = '';
    
    const file = event.target.files[0]; // Handle one file at a time
    if (file) {
        try {
            // Compress image before storing
            const compressedImage = await compressImage(file);
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                const imageData = e.target.result;
                
                // Display preview
                const img = document.createElement('img');
                img.src = imageData;
                img.className = 'image-preview';
                preview.appendChild(img);
                
                // Store in IndexedDB
                try {
                    await saveImageToIndexedDB(index, imageData);
                    checklistItems[index].image = true; // Just store a flag
                    checkComplete(index);
                    checkAllItemsComplete();
                    saveToLocalStorage();
                } catch (error) {
                    console.error('Error saving image:', error);
                    alert('Failed to save image. Please try again.');
                }
            };
            
            reader.readAsDataURL(compressedImage);
        } catch (error) {
            console.error('Error handling image upload:', error);
            alert('Failed to process image. Please try again.');
        }
    }
}

        function updateTotalScore() {
            const totalScore = checklistItems.reduce((sum, item) => {
                if (item.score > 0) {
                    return sum + (item.score * item.weight);
                }
                return sum;
            }, 0);
            
            const maxPossibleScore = checklistItems.reduce((sum, item) => {
                return sum + (5 * item.weight);
            }, 0);
            
            const percentage = ((totalScore / maxPossibleScore) * 100).toFixed(1);
            
            document.getElementById('total-score').textContent = 
                `Total Score: ${totalScore.toFixed(2)} (${percentage}% of maximum)`;
        }

async function resetForm() {
    if (confirm('Are you sure you want to reset all items? This will clear all ratings, notes, and images.')) {
        // Clear checklist items
        checklistItems.forEach(item => {
            item.score = 0;
            item.notes = '';
            item.image = null;
            item.videoUrl = undefined; 
        });
        
        // Clear inspector name
        inspectorName = '';
        document.getElementById('inspector-name').value = '';
        
        // Clear localStorage
        localStorage.removeItem('qcFormData');
        
        // Clear IndexedDB
        try {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            await store.clear();
        } catch (error) {
            console.error('Error clearing IndexedDB:', error);
        }
        
        renderChecklist();
        updateTotalScore();
        checkAllItemsComplete();
    }
}

       
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let yPosition = 20;
    const pageHeight = doc.internal.pageSize.height;
    const marginLeft = 20;
    
    // Add date
    const currentDate = new Date().toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    doc.setFontSize(14);
    doc.setTextColor(0, 0, 0);
    doc.text(currentDate, 105, yPosition, { align: "center" });
    
    // Add title
    yPosition += 20;
    doc.setFontSize(28);
    doc.text("Quality Control Report", 105, yPosition, { align: "center" });

    // Add inspector name
    yPosition += 10;
    doc.setFontSize(14);
    doc.text(`Inspector: ${inspectorName || 'Not Specified'}`, 105, yPosition, { align: "center" });
    
    // Add total score
    yPosition += 20;
    doc.setFontSize(20);
    const totalScoreElement = document.getElementById('total-score');
    doc.text(totalScoreElement.textContent, 105, yPosition, { align: "center" });
    
    // Process each checklist item
    for (const item of checklistItems) {
        yPosition += 20;
        
        // Calculate space needed
        const titleHeight = 15;
        const scoreHeight = 15;
        const notesLines = doc.splitTextToSize(`Notes: ${item.notes}`, 170).length;
        const notesHeight = notesLines * 8;
        const imageHeight = item.image ? 100 : 0;
        const videoUrlHeight = item.videoUrl ? 15 : 0;
        const totalItemHeight = titleHeight + scoreHeight + notesHeight + imageHeight + videoUrlHeight + 40;
        
        // Check for new page
        if (yPosition + totalItemHeight > pageHeight - 20) {
            doc.addPage();
            yPosition = 20;
        }
        
        // Draw colored box for scores
        const boxStartY = yPosition - 5;
        if (item.score < 4) {
            doc.setDrawColor(255, 0, 0);
            doc.setLineWidth(0.5);
        } else if (item.score >= 4) {
            doc.setDrawColor(0, 255, 0);
            doc.setLineWidth(0.5);
        }
        
        // Item name and weight
        doc.setTextColor(item.score < 4 ? 255 : 0, 0, 0);
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text(`${item.name} (Weight: ${item.weight})`, marginLeft, yPosition);
        
        // Score
        yPosition += 15;
        doc.setFontSize(16);
        doc.text(`SCORE: ${item.score}`, marginLeft, yPosition);
        if (item.score < 4) {
            doc.text('NEEDS ATTENTION', 70, yPosition);
        }
        
        // Notes
        yPosition += 15;
        doc.setFont(undefined, 'normal');
        doc.setFontSize(14);
        const splitNotes = doc.splitTextToSize(`Notes: ${item.notes}`, 170);
        doc.text(splitNotes, marginLeft, yPosition);
        yPosition += notesHeight;
        
        // Handle uploaded images
        if (item.image) {
            try {
                const imageData = await loadImageFromIndexedDB(checklistItems.indexOf(item));
                if (imageData) {
                    const img = new Image();
                    img.src = imageData;
                    
                    await new Promise((resolve) => {
                        img.onload = async () => {
                            try {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d', { alpha: false });
                                
                                const maxWidth = 150;
                                const maxHeight = 100;
                                
                                let finalWidth = img.width;
                                let finalHeight = img.height;
                                
                                if (finalWidth > maxWidth) {
                                    const ratio = maxWidth / finalWidth;
                                    finalWidth = maxWidth;
                                    finalHeight = Math.floor(finalHeight * ratio);
                                }
                                if (finalHeight > maxHeight) {
                                    const ratio = maxHeight / finalHeight;
                                    finalHeight = maxHeight;
                                    finalWidth = Math.floor(finalWidth * ratio);
                                }
                                
                                canvas.width = finalWidth * 4;
                                canvas.height = finalHeight * 4;
                                
                                ctx.imageSmoothingEnabled = true;
                                ctx.imageSmoothingQuality = 'high';
                                
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                
                                const properImage = canvas.toDataURL('image/jpeg', 1.0);
                                doc.addImage(
                                    properImage,
                                    'JPEG',
                                    marginLeft,
                                    yPosition,
                                    finalWidth,
                                    finalHeight,
                                    undefined,
                                    'NONE'
                                );
                                
                                yPosition += finalHeight + 10;
                            } catch (e) {
                                console.error('Error processing image:', e);
                            }
                            resolve();
                        };
                        img.onerror = () => resolve();
                    });
                }
            } catch (e) {
                console.error('Error adding image:', e);
            }
        }
        
        // Add video URL only (no video frames)
       
        
        
        
        
        
        // Handle video URL with wrapping
if (item.videoUrl) {
    doc.setFontSize(14);
    doc.setTextColor(0, 0, 255);
    doc.setFont(undefined, 'normal');
    
    const maxWidth = 160;
    const splitUrl = doc.splitTextToSize(`Video URL: ${item.videoUrl}`, maxWidth);
    
    splitUrl.forEach((line, i) => {
        doc.text(line, marginLeft, yPosition + (i * 15));
    });
    
    doc.link(marginLeft, yPosition - 5, maxWidth, (splitUrl.length * 15), { url: item.videoUrl });
    
    yPosition += (splitUrl.length * 15) + 5;
}
        
        // Draw box around the item if needed
        if (item.score < 4 || item.score >= 4) {
            const boxHeight = yPosition - boxStartY;
            doc.rect(15, boxStartY, 180, boxHeight, 'S');
        }
        
        yPosition += 20;
    }
    
    // Save the PDF
    const date = new Date().toISOString().split('T')[0];
    doc.save(`QC-Report-${date}.pdf`);
}
    








        

        // Load the checklist when the page loads
        loadChecklist();
    </script>
</body>
</html>
