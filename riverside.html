<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Car Wash Quality Check - Riverside</title>
    <!-- Include jsPDF and html2canvas libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        fieldset {
            margin-bottom: 20px;
            padding: 10px;
        }

        label {
            font-weight: bold;
        }

        textarea {
            width: 100%;
        }

        img {
            margin-top: 10px;
            max-width: 200px;
            max-height: 200px;
        }

        button {
            margin: 10px 5px;
        }

        .hidden {
            display: none;
        }

        #resetButton {
            position: fixed;
            top: 10px;
            right: 10px;
        }
    </style>
</head>
<body>

<h1>Car Wash Quality Check - Riverside</h1>

<!-- Reset Button at the Top -->
<button id="resetButton">Reset</button>

<form id="qualityCheckForm">

    <!-- The form content will be generated dynamically from the JSON data -->

</form>

<!-- Moved the buttons below the form -->
<button id="generatePdfButton" disabled>Make PDF Report</button>

<script>
    // *** Data Definition ***
    // Site Name
    var siteName = "Riverside";

    // JSON Data Embedded in the Script
    // This is where you can modify or replace the data as needed
    var jsonData = {
        "items": [
            {
                "id": 1,
                "name": "Roller Up",
                "weight": 0.6,
                "score": 0,
                "notes": "",
                "image": null
            },
            {
                "id": 2,
                "name": "PRE SOAK #1 Wash Service",
                "weight": 0.8,
                "score": 0,
                "notes": "",
                "image": null
            },
            {
                "id": 3,
                "name": "GRAND ENTRY FX Wash Service",
                "weight": 0.8,
                "score": 0,
                "notes": "",
                "image": null
            },
            {
                "id": 4,
                "name": "PRE SOAK #2 Wash Service",
                "weight": 0.5,
                "score": 0,
                "notes": "",
                "image": null
            }
            // Add more items as needed
        ]
    };

    // Function to generate form content
    function generateForm() {
        var form = document.getElementById('qualityCheckForm');
        form.innerHTML = ''; // Clear any existing content

        jsonData.items.forEach(function(item) {
            var fieldset = document.createElement('fieldset');
            fieldset.id = 'item-' + item.id;

            var legend = document.createElement('legend');
            legend.textContent = item.name + ' (Weight: ' + item.weight + ')';
            fieldset.appendChild(legend);

            // Notes input
            var notesLabel = document.createElement('label');
            notesLabel.textContent = 'Notes: ';
            var notesInput = document.createElement('textarea');
            notesInput.id = 'notes-' + item.id;
            notesInput.rows = 3;
            notesInput.cols = 50;
            notesInput.addEventListener('input', checkFormCompletion);
            fieldset.appendChild(notesLabel);
            fieldset.appendChild(document.createElement('br'));
            fieldset.appendChild(notesInput);
            fieldset.appendChild(document.createElement('br'));

            // Image upload
            var imageLabel = document.createElement('label');
            imageLabel.textContent = 'Image: ';
            var imageInput = document.createElement('input');
            imageInput.type = 'file';
            imageInput.accept = 'image/*';
            imageInput.id = 'image-' + item.id;
            imageInput.addEventListener('change', function(event) {
                handleImageUpload(event, item.id);
            });
            fieldset.appendChild(imageLabel);
            fieldset.appendChild(imageInput);
            fieldset.appendChild(document.createElement('br'));

            // Image preview
            var imagePreview = document.createElement('img');
            imagePreview.id = 'preview-' + item.id;
            imagePreview.classList.add('hidden');
            fieldset.appendChild(imagePreview);
            fieldset.appendChild(document.createElement('br'));

            // Rating input
            var ratingLabel = document.createElement('label');
            ratingLabel.textContent = 'Rating (1-5): ';
            var ratingSelect = document.createElement('select');
            ratingSelect.id = 'rating-' + item.id;
            ratingSelect.addEventListener('change', checkFormCompletion);
            var defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select a rating';
            ratingSelect.appendChild(defaultOption);
            for (var i = 1; i <= 5; i++) {
                var option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                ratingSelect.appendChild(option);
            }
            fieldset.appendChild(ratingLabel);
            fieldset.appendChild(ratingSelect);
            fieldset.appendChild(document.createElement('br'));

            form.appendChild(fieldset);
            form.appendChild(document.createElement('hr'));
        });
    }

    // Function to handle image upload and preview
    function handleImageUpload(event, itemId) {
        var file = event.target.files[0];
        if (file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                // Update the image preview
                var preview = document.getElementById('preview-' + itemId);
                preview.src = e.target.result;
                preview.classList.remove('hidden');
                // Update the image data in jsonData
                var item = jsonData.items.find(function(i) { return i.id === itemId; });
                item.image = e.target.result;
                checkFormCompletion();
            };
            reader.readAsDataURL(file);
        }
    }

    // Function to check if all fields are completed
    function checkFormCompletion() {
        var allCompleted = true;
        jsonData.items.forEach(function(item) {
            // Get notes
            var notesInput = document.getElementById('notes-' + item.id);
            var notesValue = notesInput.value.trim();
            item.notes = notesValue;
            if (!notesValue) {
                allCompleted = false;
            }
            // Get rating
            var ratingSelect = document.getElementById('rating-' + item.id);
            var ratingValue = ratingSelect.value;
            item.score = parseInt(ratingValue) || 0;
            if (item.score === 0) {
                allCompleted = false;
            }
            // Check image
            if (!item.image) {
                allCompleted = false;
            }
        });
        var generatePdfButton = document.getElementById('generatePdfButton');
        generatePdfButton.disabled = !allCompleted;
    }

    // Function to reset the form
    function resetForm() {
        // Reset jsonData
        jsonData.items.forEach(function(item) {
            item.score = 0;
            item.notes = '';
            item.image = null;
        });
        // Regenerate the form
        generateForm();
        checkFormCompletion();
    }

    // Function to generate the PDF report
    async function generatePdfReport() {
        var { jsPDF } = window.jspdf;
        var doc = new jsPDF();

        var totalWeightedScore = 0;
        var maximumWeightedScore = 0;

        // Placeholder for site score
        doc.setFontSize(16);
        doc.text('Quality Check Report for ' + siteName, 10, 10);
        doc.text('Site Score: Calculating...', 10, 20);

        for (var i = 0; i < jsonData.items.length; i++) {
            var item = jsonData.items[i];

            totalWeightedScore += item.score * item.weight;
            maximumWeightedScore += 5 * item.weight;

            var startY = 30;

            // Add a new page except for the first item
            if (i > 0) {
                doc.addPage();
            }

            // Add item name
            doc.setFontSize(14);
            doc.text(item.name, 10, startY);

            // Add notes
            doc.setFontSize(12);
            doc.text('Notes:', 10, startY + 10);
            var splitNotes = doc.splitTextToSize(item.notes, 180);
            doc.text(splitNotes, 10, startY + 15);

            // Add rating
            doc.text('Rating: ' + item.score + ' (Weight: ' + item.weight + ')', 10, startY + 35);

            // Add image
            if (item.image) {
                await new Promise(function(resolve) {
                    var img = new Image();
                    img.onload = function() {
                        var width = this.width;
                        var height = this.height;
                        var maxWidth = 180;
                        var maxHeight = 100;
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                        doc.addImage(this, 'JPEG', 10, startY + 45, width, height);
                        resolve();
                    };
                    img.src = item.image;
                });
            }
        }

        // Calculate and update site score
        var siteScorePercentage = (totalWeightedScore / maximumWeightedScore) * 100;
        doc.setPage(1);
        doc.setFontSize(16);
        doc.text('Quality Check Report for ' + siteName, 10, 10);
        doc.text('Site Score: ' + siteScorePercentage.toFixed(2) + '%', 10, 20);

        // Save the PDF
        doc.save('Quality_Check_Report_' + siteName + '.pdf');
    }

    // Initialize the form when the page loads
    window.onload = function() {
        generateForm();
    };

    // Event listeners
    document.getElementById('resetButton').addEventListener('click', function() {
        if (confirm('Are you sure you want to reset? All data will be lost.')) {
            resetForm();
        }
    });
    document.getElementById('generatePdfButton').addEventListener('click', generatePdfReport);

</script>

</body>
</html>
