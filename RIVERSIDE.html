<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIVERSIDE QC</title>
    <style>
        .container {
            max-width: 800px;
            margin: auto;
            font-family: Arial, sans-serif;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        .form-item {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .rating-buttons {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }

        .rating-buttons label {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .rating-buttons input {
            margin-right: 5px;
        }

        input[type="file"], textarea {
            display: block;
            width: 100%;
            margin-top: 5px;
            margin-bottom: 10px;
        }

        .image-preview {
            margin-top: 10px;
            border: 1px solid #ddd;
            max-width: 200px;
            height: auto;
        }

        button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-top: 20px;
            background: #007BFF;
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        button:hover:not(:disabled) {
            background: #0056b3;
        }

        .error {
            color: red;
            font-size: 12px;
            margin-top: -5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>RIVERSIDE Quality Control Checklist</h1>
        <form id="qc-form">
            <div id="checklist-container"></div>
            <button type="button" id="generate-pdf" disabled>Generate PDF</button>
        </form>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const form = document.getElementById('qc-form');
            const checklistContainer = document.getElementById('checklist-container');
            const generatePdfButton = document.getElementById('generate-pdf');

            // Fetch JSON data
            const response = await fetch('https://ultraexpress.github.io/QC/riverside-checklist.json');
            const data = await response.json();

            let completionStatus = [];
            const perfectScore = data.items.reduce((sum, item) => sum + item.weight * 5, 0); // Max score

            // Build form dynamically
            data.items.forEach((item, index) => {
                completionStatus[index] = false;

                const formItem = document.createElement('div');
                formItem.classList.add('form-item');
                formItem.setAttribute('data-weight', item.weight);

                formItem.innerHTML = `
                    <label for="item-${index}">${item.name}</label>
                    <div class="rating-buttons">
                        <label>
                            <input type="radio" name="rating-${index}" value="1" required> 1 = Terrible (Non-working)
                        </label>
                        <label>
                            <input type="radio" name="rating-${index}" value="2" required> 2
                        </label>
                        <label>
                            <input type="radio" name="rating-${index}" value="3" required> 3 = Average
                        </label>
                        <label>
                            <input type="radio" name="rating-${index}" value="4" required> 4
                        </label>
                        <label>
                            <input type="radio" name="rating-${index}" value="5" required> 5 = Excellent (Perfect condition)
                        </label>
                    </div>
                    <textarea placeholder="Enter notes" name="notes-${index}" required></textarea>
                    <input type="file" name="image-${index}" accept="image/*" data-index="${index}" required>
                    <img id="preview-${index}" class="image-preview" src="#" alt="Preview" style="display:none;">
                    <span class="error" id="error-${index}"></span>
                `;

                checklistContainer.appendChild(formItem);

                const radios = formItem.querySelectorAll(`input[name="rating-${index}"]`);
                const notes = formItem.querySelector(`textarea`);
                const fileInput = formItem.querySelector(`input[name="image-${index}"]`);

                const validateItem = () => {
                    const ratingSelected = Array.from(radios).some((radio) => radio.checked);
                    const notesFilled = notes.value.trim() !== '';
                    const fileUploaded = fileInput.files.length > 0;

                    if (ratingSelected && notesFilled && fileUploaded) {
                        completionStatus[index] = true;
                        document.getElementById(`error-${index}`).textContent = '';
                    } else {
                        completionStatus[index] = false;
                        document.getElementById(`error-${index}`).textContent =
                            'Complete all fields (rating, notes, and image).';
                    }

                    generatePdfButton.disabled = !completionStatus.every((status) => status === true);
                };

                radios.forEach((radio) => radio.addEventListener('change', validateItem));
                notes.addEventListener('input', validateItem);
                fileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const preview = document.getElementById(`preview-${index}`);
                            preview.src = e.target.result;
                            preview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                    validateItem();
                });
            });

            generatePdfButton.addEventListener('click', async () => {
                const items = document.querySelectorAll('.form-item');
                let totalScore = 0;
                const pdfData = [];

                for (const [index, item] of items.entries()) {
                    const weight = parseFloat(item.dataset.weight);
                    const rating = item.querySelector(`input[name="rating-${index}"]:checked`);
                    const notes = item.querySelector(`textarea`).value;
                    const image = item.querySelector(`input[name="image-${index}"]`).files[0];

                    const weightedScore = weight * parseFloat(rating.value);
                    totalScore += weightedScore;

                    const reader = new FileReader();
                    const imageBase64 = await new Promise((resolve) => {
                        reader.onload = () => resolve(reader.result);
                        reader.readAsDataURL(image);
                    });

                    pdfData.push({
                        name: data.items[index].name,
                        notes,
                        rating: rating.value,
                        weightedScore,
                        imageBase64,
                    });
                }

                generatePDF(pdfData, totalScore, perfectScore);
            });

            const generatePDF = async (pdfData, totalScore, perfectScore) => {
                const pdfDoc = await PDFLib.PDFDocument.create();
                const percentageScore = ((totalScore / perfectScore) * 100).toFixed(2);

                const firstPage = pdfDoc.addPage([600, 900]);
                firstPage.drawText(`RIVERSIDE Quality Control Report`, { x: 50, y: 850, size: 18 });
                firstPage.drawText(`Total Score: ${totalScore.toFixed(2)} / ${perfectScore.toFixed(2)}`, { x: 50, y: 820 });
                firstPage.drawText(`Site Score: ${percentageScore}%`, { x: 50, y: 800 });

                for (const item of pdfData) {
                    const page = pdfDoc.addPage([600, 900]);
                    page.drawText(`Item: ${item.name}`, { x: 50, y: 850 });
                    page.drawText(`Notes: ${item.notes}`, { x: 50, y: 820 });
                    page.drawText(`Rating: ${item.rating}`, { x: 50, y: 800 });
                    page.drawText(`Weighted Score: ${item.weightedScore.toFixed(2)}`, { x: 50, y: 780 });

                    const imageBytes = await fetch(item.imageBase64).then((res) => res.arrayBuffer());
                    const imageEmbed = await pdfDoc.embedPng(imageBytes);
                    page.drawImage(imageEmbed, {
                        x: 50,
                        y: 600,
                        width: 200,
                        height: 200,
                    });
                }

                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
